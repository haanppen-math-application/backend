name: Deploy to Amazon EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: checkout
      uses: actions/checkout@2

    - name: test
      run: ./gradle clean test
      
    - name: ssh access to ec2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USERNAME }}
        key: ${{ secrets.AWS_SSH_KEY }}
        script: |
          cd /home/ubuntu/projects/hanpyeon-academy
          git pull origin main
          ./gradlew build 
          sudo chmod 100 build/libs/academyapi-0.0.1-SNAPSHOT-plain.jar
          sudo chmod 100 build/libs/academyapi-0.0.1-SNAPSHOT.jar
          
          java -jar academyapi-0.0.1-SNAPSHOT.jar
          
          
        
